name: Issue command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    if: >
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/run') &&
      github.actor == github.event.issue.user.login &&
      github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Resolve executor and reviewer
        id: who
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo, number} = context.issue;
            const issueAuthor   = context.payload.issue.user.login;     // A
            const executor      = context.payload.comment.user.login;   // /run 実行者
            const runCreatedAt  = new Date(context.payload.comment.created_at).toISOString();

            // 直前までのコメントを取得してレビュアーを特定（"approve" を含む最新）
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: number, per_page: 100 }
            );

            const reviewerComment = comments
              .filter(c =>
                new Date(c.created_at).toISOString() < runCreatedAt &&
                c.user.login !== issueAuthor &&
                c.user.login !== executor &&
                /(^|\b)approve(s|d)?(\b|!|\.|:)?/i.test(c.body || '')
              )
              .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))[0];

            if (!reviewerComment) {
              core.setFailed('承認コメントが見つかりませんでした。'); // レビュアー必須
              return;
            }

            const reviewer = reviewerComment.user.login; // B
            core.setOutput('issue_author', issueAuthor);
            core.setOutput('executor', executor);
            core.setOutput('reviewer', reviewer);

      # 任意の処理
      - name: Do work
        id: work
        run: |
          echo "result=OK" >> "$GITHUB_OUTPUT"

      - name: Comment back to the issue
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo, number} = context.issue;
            const issueAuthor = '${{ steps.who.outputs.issue_author }}';
            const executor    = '${{ steps.who.outputs.executor }}';
            const reviewer    = '${{ steps.who.outputs.reviewer }}';
            const result      = '${{ steps.work.outputs.result }}';

            await github.rest.issues.createComment({
              owner, repo, issue_number: number,
              body: [
                '処理を受け付けました。',
                `- 作成者: @${issueAuthor}`,
                `- レビュアー: @${reviewer}`,
                `- 実行者: @${executor}`,
                `- 結果: **${result}**`
              ].join('\n')
            })
