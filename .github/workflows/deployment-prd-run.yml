name: Issue command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    if: >
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/run') &&
      github.actor == github.event.issue.user.login &&
      github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Comment workflow started
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "コマンドの実行を開始しました。実行URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Resolve executor and reviewer
        id: who
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          issue_author="${{ github.event.issue.user.login }}"
          executor="${{ github.event.comment.user.login }}"
          run_created_at="${{ github.event.comment.created_at }}"
          
          echo "issue_author=${issue_author}" >> "$GITHUB_OUTPUT"
          echo "executor=${executor}" >> "$GITHUB_OUTPUT"
          
          # コメント一覧を取得
          comments=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            --paginate)
          
          # レビュアーを特定（approve を含む最新のコメント）
          reviewer=$(echo "$comments" | jq -r --arg run_created_at "$run_created_at" \
            --arg issue_author "$issue_author" \
            --arg executor "$executor" \
            '[.[] | select(
              (.created_at < $run_created_at) and
              (.user.login != $issue_author) and
              (.user.login != $executor) and
              (.body | test("(^|\\b)approve(s|d)?(\\b|!|\\.|:)?"; "i"))
            )] | sort_by(.created_at) | reverse | .[0].user.login // empty')
          
#          if [ -z "$reviewer" ]; then
#            echo "::error::承認コメントが見つかりませんでした。"
#            exit 1
#          fi
          
          echo "reviewer=${reviewer}" >> "$GITHUB_OUTPUT"

      # 任意の処理
      - name: Do work
        id: work
        run: |
          echo "result=OK" >> "$GITHUB_OUTPUT"

      - name: Comment back to the issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "処理を受け付けました。
          - 作成者: @${{ steps.who.outputs.issue_author }}
          - レビュアー: @${{ steps.who.outputs.reviewer }}
          - 実行者: @${{ steps.who.outputs.executor }}
          - 結果: **${{ steps.work.outputs.result }}**"
